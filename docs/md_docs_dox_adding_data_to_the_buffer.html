<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PBuf: Adding Data to the Buffer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PBuf
   &#160;<span id="projectnumber">0.2.1</span>
   </div>
   <div id="projectbrief">Priority Buffer</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_docs_dox_adding_data_to_the_buffer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Adding Data to the Buffer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Symbol meanings</h2>
<p>For the sake of this document, I shall employ the following symbols in the examples that follow:</p><ol type="1">
<li>Priority is indicated with the letters <code>h</code>, <code>m</code>, and <code>l</code>, indicating, high, medium and low priorities. Note there can be up to 8 levels of priority in practice, but here we will only deal with three for clarity. The number following the letter indicates the number of elements of this priority in the buffer.</li>
<li>A number following the priority letter indicates the order in which elements are <em>inserted into</em> the buffer, rather than the order they are <em>retrieved from</em> the buffer.</li>
</ol>
<ol type="1">
<li><code>x</code> indicates unused but available storage in the buffer.</li>
<li><code>H</code> followed by a priority letter indicate a Head related to said priority, as in <code>Hm</code> representing <em>Head associated with the Medium priority buffer data.</em></li>
<li><code>T</code> and <code>T*</code> represent <em>Tail</em> and <em>Tail pointer</em> respectively.</li>
</ol>
<h3>Adding data to an empty buffer</h3>
<h4>Initially:</h4>
<div class="fragment"><div class="line">x  -&gt;  x  -&gt;  x  -&gt;  x  -&gt;  ...</div><div class="line">T*</div></div><!-- fragment --><p>Since the data to be added will be the only data in the buffer it will naturally be the highest priority data on the buffer. In this case we can simply add the data at the element indicated by the tail pointer (T*) and set the relevant head pointer (Hl* or Hm* or Hh*). We also need to set the active flag for the relevant priority to indicate we have data of this priority in the buffer.</p>
<h3>Adding l1 becomes:</h3>
<div class="fragment"><div class="line">l1  -&gt;  x  -&gt;  x  -&gt;  x  -&gt;  ...</div><div class="line">T*</div><div class="line">Hl*</div></div><!-- fragment --><h2>Adding data of the lowest priority to a partially full buffer containing only low priority</h2>
<h3>Initially:</h3>
<div class="fragment"><div class="line">l1  -&gt;  l2  -&gt;  l3  -&gt;  x  -&gt;  ...</div><div class="line">T*</div><div class="line">                Hl      Hl*</div></div><!-- fragment --><p>Since the buffer contains data in a high priority first, through lower priorities, to lower priority order, to add data of the lowest priority we can simply add the data at the buffer position indicated by the relevant head pointer H* and advance the Head Hl. The relevant active flag is already set, but we set it anyway since it is quicker to just set the flag than test the flag and set it.</p>
<h3>Adding l4 becomes:</h3>
<div class="fragment"><div class="line">l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;  x  ...</div><div class="line">T*</div><div class="line">                        Hl      Hl*</div></div><!-- fragment --><h2>Adding data of the lowest priority to a partially full buffer containing mixed priorities</h2>
<h3>Initially:</h3>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt; m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  x  -&gt;  ...</div><div class="line">T*</div><div class="line">                Hh                     Hm      Hl      Hl*</div></div><!-- fragment --><p>Similarly to the previous example, here we simply add the new element to the buffer at the position indicated by the relevant head pointer. We then advance the relevant head and set the relevant active flag. Since the added data is of the lowest priority it needs to be at the end of the buffer, so we need to do anything more here.</p>
<h3>Adding l2 becomes:</h3>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt; m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  l2  -&gt;  x  -&gt;  ...</div><div class="line">T*</div><div class="line">                Hh                     Hm              Hl      Hl*</div></div><!-- fragment --><h2>Adding data of a high priority to a partially full buffer containing mixed priorities</h2>
<h3>Initially:</h3>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt; m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  x  -&gt;  ...</div><div class="line">T*</div><div class="line">                Hh                     Hm      Hl      Hl*</div></div><!-- fragment --><p>We now wish to add high priority data to a buffer of mixed priorities. In this case we need the data to be placed after data of a similar or higher priorities but before data of a lower priority. This is a two stage process. Stage 1 involves where to store the data in the physical buffer and stage 2 involves rearranging the buffer to set the data at the correct level of importance in the buffer, which is behind than data of a higher or similar priority, but ahead of lower priority data.</p>
<h3>Adding h4 to the buffer:</h3>
<p>Since the buffer is not full we can add the data to an unused element (marked by x) that is pointed to by the lowest active Head pointer:</p>
<h3>Stage 1:</h3>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt; m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  h4  -&gt;  x  ...</div><div class="line">T*</div><div class="line">                Hh                     Hm      Hl      Hl*</div></div><!-- fragment --><p>The buffer is now out of order since we have higher priority data that is behind low priority data. We can correct this anomaly by remapping, or re-routing the buffer (since we have a link between adjacent elements). This is achieved by reassigning links in such a way that the new entry is placed behind data of higher and equal priority to itself, and ahead of data of lower priority to itself. This will re-establish the correct prioritisation in the buffer.</p>
<h3>Finding the before insertion point:</h3>
<p>As indicated we need to place the data behind all data of higher or equal priority. To find this point we simply need to examine the activity flags starting at the current priority, and find the first active flag of equal or higher priority. If no such priority is active then we become the highest priority in the buffer and need to be inserted at the front of the buffer. If higher or equal priority exists we establish the priority closest to the current priority in increasing priority. In our case this is the highest priority. Therefore we need to be placed between the Hh head pointer and the element following. This is achieved by:</p>
<ol type="1">
<li>saving the link at h3 in our case (which currently links to m1)</li>
<li>writing the position of the newly inserted data to the link at h3 (in our case the position of h4)</li>
<li>writing the current link of the newly inserted data to the pointer Hh* link (in our case m1)</li>
<li>writing the saved link to the current link (in our case h4*)</li>
<li>setting the relevant head pointer to indicate the new priority head.</li>
<li>setting the relevant priority activity flag incase it hasn't been set already.</li>
</ol>
<h3>Stage 2:</h3>
<p>Below shows how the links are broken and rearranged as above. The affect is to place the element h4 behind the element h3 and ahead of m1.</p>
<div class="fragment"><div class="line">                    ------------------------------&gt;</div><div class="line">                      &lt;------------------------------------</div><div class="line">                                                    -------&gt;</div><div class="line">h1  -&gt;  h2  -&gt;  h3     m1  -&gt;  m2  -&gt;  m3  -&gt;  l1      h4      x  ...</div><div class="line">T*</div><div class="line">                                       Hm      Hl      Hh</div></div><!-- fragment --><p>Below we see the buffer after redrawing and allowing for re-linking:</p>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt;  h4  -&gt;   m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  x  ...</div><div class="line">T*</div><div class="line">                        Hh                       Hm      Hl</div></div><!-- fragment --><h2>Adding data to a full buffer</h2>
<p>To add data to a full buffer we are required to push the oldest lowest priority data 'out the back' of the buffer, since we no longer have room to accomodate additional data. This ensures that the limited buffer space is reserved for the higher priority data and newer data of the lowest priority.</p>
<h2>Attempting to add data of a lower priority that currently exists in a full buffer</h2>
<p>If the data to be added is of a lower priority than any of the data in the buffer (indicated by an inactive activity flag at the new priority), then the data is rejected, the buffer left untouched and an insertion error returned to the caller.</p>
<h2>Adding data to a full buffer where the buffer is full of a single priority</h2>
<p>Where we are adding newer data to a full buffer containing only data of a similar priority we can simply overwrite the oldest data in the buffer with our newest data, and advance the tail pointer to the next position. In this way the latest insert is pushed to the back of the queue.</p>
<h3>Initially:</h3>
<div class="fragment"><div class="line">l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8  -&gt;  l9  -&gt;  l10</div><div class="line">T*                                                                       T</div><div class="line">                                                                         Hl</div></div><!-- fragment --><h3>Adding l11 becomes:</h3>
<div class="fragment"><div class="line">l11 -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8  -&gt;  l9  -&gt;  l10</div><div class="line">T*                                                                       T</div><div class="line">                                                                         Hl</div></div><!-- fragment --><h3>Then advancing the Tail pointer:</h3>
<div class="fragment"><div class="line">l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8  -&gt;  l9  -&gt;  l10  -&gt;  l11</div><div class="line">T*                                                                        T</div><div class="line">                                                                          Hl</div></div><!-- fragment --><h2>Adding data to a full buffer containing a mix of priority</h2>
<p>Assuming we have data of a higher or equal priority we can add it to the buffer by pushing less important data (older or lower priority) out of the buffer. This is a two stage process - stage 1 is involved with determining where to store the new data - stage 2 involves remapping or re-routing the links of the buffer to insert the data between data of higher importance (higher priority or newer) and data of lower importance (lower priority).</p>
<h3>Stage 1:</h3>
<h4>To add m4:</h4>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt;  h4  -&gt;   m1  -&gt;  m2  -&gt;  m3  -&gt;  l1  -&gt;  l2</div><div class="line">T*                                                               T</div><div class="line">                        Hh                       Hm              Hl</div></div><!-- fragment --><p>Here we have a full buffer containing a mix of prioritisation. To add our data (m4) we need to determine the element containing the lowest priority and oldest element. In our case this is the element l1. Regardless of which priority we are adding this is the element to get overwritten since it it has the least importance.</p>
<h3>Overwriting:</h3>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt;  h4  -&gt;   m1  -&gt;  m2  -&gt;  m3  -&gt;  m4  -&gt;  l2</div><div class="line">T*                                                               T</div><div class="line">                        Hh                       Hm              Hl</div></div><!-- fragment --><p>Here we need to overwrite l1 with m4 as shown. Since we haven't a direct pointer to l1 we need to find l1 some other way. l1 can be considered the 'tail' of priority 'l'. This can be determined by finding the next highest priority on the buffer (that is the next active priority) and following the link of that priority's relevant head. In our case the next highest priority to l1 is priority m. We follow the link given by the head Hm to l1 and overwrite m4 there.</p>
<p>In this case the buffer is still in the correct order and we simply need to advance the Hm head:</p>
<div class="fragment"><div class="line">h1  -&gt;  h2  -&gt;  h3  -&gt;  h4  -&gt;   m1  -&gt;  m2  -&gt;  m3  -&gt;  m4  -&gt;  l2</div><div class="line">T*                                                               T</div><div class="line">                        Hh                               Hm      Hl</div></div><!-- fragment --><h2>Adding data to a full buffer of a priority higher than any on the buffer</h2>
<h3>Initially:</h3>
<div class="fragment"><div class="line">m1  -&gt;  m2  -&gt;  m3  -&gt;  m4  -&gt;  l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5</div><div class="line">T*                                                               T</div><div class="line">                        Hm                                       Hl</div></div><!-- fragment --><p>In this buffer we have data of priority m and data of priority l but no data of priority h. Say we need to add h1 to the buffer. We first need to identify the oldest, lowest priority element and overwrite it with the new data:</p>
<h3>Overwriting l1 with h1:</h3>
<div class="fragment"><div class="line">m1  -&gt;  m2  -&gt;  m3  -&gt;  m4  -&gt;  h1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  (  -&gt;  m1)</div><div class="line">T*                                                               T   (      T*)</div><div class="line">                        Hm                                       Hl</div></div><!-- fragment --><p>Here we have overwritten l1 with h1. However the buffer clearly requires re-adjusting to correct the priorities. This is a similar process to that considered above.</p>
<h3>Required adjustment:</h3>
<div class="fragment"><div class="line">                             &lt;------------------------------------</div><div class="line">&lt;------------------------------------</div><div class="line">                            --------&gt;</div><div class="line">m1  -&gt;  m2  -&gt;  m3  -&gt;  m4      h1      l2  -&gt;  l3  -&gt;  l4  -&gt;   l5</div><div class="line">T*                                                               T</div><div class="line">                        Hm                                       Hl</div></div><!-- fragment --><p>Notice here that the T* needs to move since the higher priority becomes the front of the queue;</p>
<h3>Rearranged gives:</h3>
<div class="fragment"><div class="line">h1  -&gt;  m1  -&gt;  m2  -&gt;  m3  -&gt;  m4  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5</div><div class="line">T*                                                               T</div><div class="line">                                Hm                               Hl</div></div><!-- fragment --><h2>Retrieving Data from the buffer:</h2>
<h3>Initially:</h3>
<div class="fragment"><div class="line">l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8  -&gt;  l9  -&gt;  l10</div><div class="line">T*                                                                       T</div><div class="line">                                                                         Hl</div></div><!-- fragment --><p>To remove data from the buffer we first check that the buffer is not empty. If it is empty an error is returned to the caller. If the buffer is not empty we return the element pointed to by the Tail pointer T* and advance the Tail pointer.</p>
<h3>Following retrieval:</h3>
<div class="fragment"><div class="line">l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8  -&gt;  l9  -&gt;  l10</div><div class="line">T*                                                               T</div><div class="line">                                                                 Hl</div></div><!-- fragment --><p>We must determine whether we have depleted a particular priority from the buffer, and mark that priority inactive if this is the case. This is detected by comparing the highest active priority's head pointer with the tail pointer prior to advancing the tail pointer. If they are equal we are about to deplete the highest priority and need to make the priority inactive:</p>
<h3>Depleted Priority:</h3>
<div class="fragment"><div class="line">h1  -&gt;  l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8</div><div class="line">T*                                                               T</div><div class="line">Hh                                                               Hl</div></div><!-- fragment --><p>In this case there is only a single active priority on the buffer and a single relevant head pointer:</p>
<h3>Becomes:</h3>
<div class="fragment"><div class="line">l1  -&gt;  l2  -&gt;  l3  -&gt;  l4  -&gt;   l5  -&gt;  l6  -&gt;  l7  -&gt;  l8</div><div class="line">T*                                                       T</div><div class="line">                                                         Hl</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
